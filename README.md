# tinkoffAcademyTask
<div _ngcontent-abw-c284="" class="tui-col_xs-12 tui-col_s-12 tui-col_sm-12 tui-col_md-7 tui-col_lg-8 quiz"><app-task _ngcontent-abw-c284="" _nghost-abw-c270=""><app-programming-task _ngcontent-abw-c270="" _nghost-abw-c252="" class="ng-star-inserted"><div _ngcontent-abw-c252="" class="tui-form__header tui-form__header_margin-top_none tui-form__header_margin-bottom_small header"><div _ngcontent-abw-c252="" class="header">1&nbsp;задание</div></div><div _ngcontent-abw-c252="" class="tui-form__row"><div _ngcontent-abw-c252="" class="condition"><div _ngcontent-abw-c252="" class="condition-item"><div _ngcontent-abw-c252="" class="condition-title">Ограничение времени</div><div _ngcontent-abw-c252="" class="condition-description">5 секунд</div></div><div _ngcontent-abw-c252="" class="condition-item"><div _ngcontent-abw-c252="" class="condition-title">Ограничение памяти</div><div _ngcontent-abw-c252="" class="condition-description">256 МБ</div></div><tui-marker-icon _ngcontent-abw-c252="" size="xl" src="tuiIconCogMarker" class="condition-icon" _nghost-abw-c158="" data-size="xl"><tui-svg _ngcontent-abw-c158="" class="t-icon" _nghost-abw-c60=""><svg _ngcontent-abw-c60="" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" focusable="false" width="100%" height="100%" class="ng-star-inserted"><use _ngcontent-abw-c60="" xlink:href="assets/taiga-ui/icons/tuiIconCogMarker.svg#tuiIconCogMarker"></use></svg><!----><!----><!----><!----></tui-svg></tui-marker-icon></div><div _ngcontent-abw-c252="" class="task"><app-quill-content-display _ngcontent-abw-c252="" _nghost-abw-c246=""><div _ngcontent-abw-c246="" class="ql-container ql-disabled"><div class="ql-editor" data-gramm="false" contenteditable="false"><h5>Предисловие</h5><p><span style="color: rgb(63, 67, 80);">Вам предлагается на выполнение задание на моделирование “Умного дома”. </span><strong style="color: rgb(63, 67, 80);">Время на выполнение этого задания - 96 часов. Не обращайте внимание на то, что на странице задачи таймер отсчитывает 24 часа!</strong></p><p><span style="color: rgb(63, 67, 80);">Выполнить его вы должны </span><strong style="color: rgb(63, 67, 80);">на том языке программирования, на направление по которому планируете поступать</strong><span style="color: rgb(63, 67, 80);"> (Scala, Python, Java, Go). Если вы пишите на java, go, вам доступна только стандартная библиотека соответствующих языков. Если вы пишете на scala, помимо стандартной библиотеки разрешается использовать sttp (</span><a href="https://sttp.softwaremill.com/en/stable/examples.html#use-the-simple-synchronous-client" rel="noopener noreferrer" target="_blank">https://sttp.softwaremill.com/en/stable/examples.html#use-the-simple-synchronous-client</a>). Для языка python разрешается использовать requests.</p><p><span style="color: rgb(63, 67, 80);">В задании не потребуется знание каких-то языково-специфичных конструкций или особенностей стандартной библиотеки или </span><strong style="color: rgb(63, 67, 80);">API</strong><span style="color: rgb(63, 67, 80);">, за исключением работы с </span><strong style="color: rgb(63, 67, 80);">HTTP POST </strong><span style="color: rgb(63, 67, 80);">запросами на сервер. От вас потребуется знание основ программирования, таких как работа со строками, последовательностями байт и битами внутри байта, и базовых структур данных (массивов, списков).</span></p><p><span style="color: rgb(63, 67, 80);">Текст задания может сначала показаться большим и страшным, и чтобы справиться со сложностью вы можете разделить выполнение задания на несколько этапов.</span></p><ul><li><span style="color: rgb(63, 67, 80);">Научитесь подключаться к серверу и выполнять</span><strong style="color: rgb(63, 67, 80);"> HTTP POST</strong><span style="color: rgb(63, 67, 80);"> запросы на сервер, передавая ему уже готовые закодированные сообщения.</span></li><li><span style="color: rgb(63, 67, 80);">Научитесь кодировать и декодировать </span><strong style="color: rgb(63, 67, 80);">URL-encoded unpadded base64</strong><span style="color: rgb(63, 67, 80);"> для отправки на сервер и приёма данных от сервера.</span></li><li><span style="color: rgb(63, 67, 80);">Научитесь кодировать и декодировать пакеты из бинарной формы в ваше внутреннее представление.</span></li><li><span style="color: rgb(63, 67, 80);">Научитесь выявлять структуру сети устройств с помощью </span><strong style="color: rgb(63, 67, 80);">WHOISHERE</strong><span style="color: rgb(63, 67, 80);">.</span></li><li><span style="color: rgb(63, 67, 80);">Научитесь управлять одной лампой и одним выключателем.</span></li><li><span style="color: rgb(63, 67, 80);">Реализуйте весь требуемый функционал.</span></li></ul><p><span style="color: rgb(63, 67, 80);">Для вашего удобства вам предоставляется готовая (консольная) программа - модельный сервер, на котором вы можете отлаживаться. Кроме того эта программа умеет кодировать и декодировать пакеты. Для того, чтобы посмотреть доступные опции работы программы, воспользуйтесь опцией </span><strong style="color: rgb(63, 67, 80);">–help</strong><span style="color: rgb(63, 67, 80);">. Модельный сервер располагается здесь: </span><a href="https://github.com/blackav/smart-home-binary" rel="noopener noreferrer" target="_blank">https://github.com/blackav/smart-home-binary</a></p><h5><span style="color: rgb(63, 67, 80);">Условие задачи</span></h5><p><span style="color: rgb(63, 67, 80);">Напишите программу, которая реализует функции хаба умного дома. В умном доме размещены </span><em style="color: rgb(63, 67, 80);">сенсоры</em><span style="color: rgb(63, 67, 80);">, то есть устройства, измеряющие параметры окружающей среды, </span><em style="color: rgb(63, 67, 80);">актуаторы</em><span style="color: rgb(63, 67, 80);">, то есть устройства, воздействующие на среду в доме, </span><em style="color: rgb(63, 67, 80);">таймер</em><span style="color: rgb(63, 67, 80);">, передающий показания текущего времени, и </span><em style="color: rgb(63, 67, 80);">хаб</em><span style="color: rgb(63, 67, 80);">, то есть устройство, которое управляет всеми остальными устройствами в умном доме.</span></p><p><span style="color: rgb(63, 67, 80);">Все устройства находятся в общей коммуникационной среде (сети). Информация по сети&nbsp;передаётся с помощью пакетов. Пакет может отправляться одному устройству, либо всем устройствам одновременно (</span><strong style="color: rgb(63, 67, 80);">broadcast</strong><span style="color: rgb(63, 67, 80);">). Каждое устройство, включая хаб, имеет свой уникальный 14-битный адрес в сети. Коммуникационная среда ненадёжна, то есть пакеты могут в сети теряться либо портиться, но пакеты не дублируются, то есть ситуация, когда получатель получает один и тот же пакет несколько раз, невозможна.</span></p><p><span style="color: rgb(63, 67, 80);">Для моделирования функциональности хаба умного дома ваша программа должна получать данные из сети, и в качестве реакции на полученные данные отправлять данные в сеть. В рамках данной задачи получение данных из сети и отправка данных в сеть моделируется с помощью </span><strong style="color: rgb(63, 67, 80);">HTTP POST </strong><span style="color: rgb(63, 67, 80);">запроса на специальный сервер, который моделирует функционирование остальных устройств умного дома.</span></p><h6><span style="color: rgb(63, 67, 80);">Описание формата пакетов</span></h6><p><span style="color: rgb(0, 0, 0);">Для описания формата данных, передаваемых по сети, используются следующие типы данных:</span></p><ul><li><strong style="color: rgb(0, 0, 0);">byte </strong>—<span style="color: rgb(0, 0, 0);"> беззнаковое 8-битное значение (октет).</span></li><li><strong style="color: rgb(0, 0, 0);">bytes</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> массив байтов переменного размера, этот тип должен конкретизироваться в описании конкретных форматов пакетов в зависимости от типа пакета и типа устройства.</span></li><li><strong style="color: rgb(0, 0, 0);">string</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> строка. Первый байт строки хранит ее длину, затем идут символы строки, в строке допустимы символы (байты) с кодами 32-126 (включительно).</span></li><li><strong style="color: rgb(0, 0, 0);">varuint</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> беззнаковое целое число в формате ULEB128.</span></li><li><strong style="color: rgb(0, 0, 0);">[]T </strong>—<span style="color: rgb(0, 0, 0);"> массив элементов типа T, первый байт памяти, отводимой под массив, это длина массива, далее следуют байты, кодирующие элементы массива.</span></li><li><strong style="color: rgb(0, 0, 0);">struct</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> структура, состоящая из полей произвольного типа. Структура может иметь переменный размер, поскольку поля структуры могут иметь переменный размер, например varuint, string, и т. п.</span></li></ul><p><span style="color: rgb(0, 0, 0);">Каждый пакет, передаваемый по сети, описывается следующим образом:</span></p><pre class="ql-syntax" spellcheck="false">type packet struct {
&nbsp; length byte
&nbsp; payload bytes
&nbsp; crc8 byte
};
</pre><p>Где:</p><ul><li><strong style="color: rgb(0, 0, 0);">length</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> это размер поля</span><strong style="color: rgb(0, 0, 0);"> payload</strong><span style="color: rgb(0, 0, 0);"> в октетах (байтах); </span></li><li><strong style="color: rgb(0, 0, 0);">payload</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> данные, передаваемые в пакете, конкретный формат данных для каждого типа пакета описывается ниже;</span></li><li><strong style="color: rgb(0, 0, 0);">crc8 </strong>—<span style="color: rgb(0, 0, 0);"> контрольная сумма поля </span><strong style="color: rgb(0, 0, 0);">payload</strong><span style="color: rgb(0, 0, 0);">, вычисленная по алгоритму </span><a href="http://www.sunshine2k.de/articles/coding/crc/understanding_crc.html" rel="noopener noreferrer" target="_blank" style="color: rgb(0, 0, 0);">cyclic redundancy check 8 </a><span style="color: rgb(0, 0, 0);">(</span><a href="http://www.sunshine2k.de/articles/coding/crc/understanding_crc.html" rel="noopener noreferrer" target="_blank" style="color: rgb(0, 0, 0);">http://www.sunshine2k.de/articles/coding/crc/understanding_crc.html</a><span style="color: rgb(0, 0, 0);">) (по этой ссылке есть конкретный код вычисления CRC8, используйте его).</span></li></ul><p><span style="color: rgb(0, 0, 0);">Полезная нагрузка (поле </span><strong style="color: rgb(0, 0, 0);">payload</strong><span style="color: rgb(0, 0, 0);">) имеет следующую структуру:</span></p><pre class="ql-syntax" spellcheck="false">type payload struct {
&nbsp;&nbsp;src varuint
&nbsp; dst varuint
&nbsp;&nbsp;serial varuint
&nbsp; dev_type byte
&nbsp;&nbsp;cmd byte
&nbsp;&nbsp;cmd_body bytes
};
</pre><p>Где:</p><ul><li><strong style="color: rgb(0, 0, 0);">src</strong><span style="color: rgb(0, 0, 0);"> - это 14-битный “адрес” устройства-отправителя; </span></li><li><strong style="color: rgb(0, 0, 0);">dst</strong><span style="color: rgb(0, 0, 0);"> - 14-битный “адрес” устройства-получателя, причем адреса 0x0000 и 0x3FFF (16383) зарезервированы. Адрес 0x3FFF означает “широковещательную” рассылку, то есть данные адресованы всем устройствам одновременно; </span></li><li><strong style="color: rgb(0, 0, 0);">serial</strong><span style="color: rgb(0, 0, 0);"> - это порядковый номер пакета, отправленного устройством, от момента его включения. </span><strong style="color: rgb(0, 0, 0);">serial</strong><span style="color: rgb(0, 0, 0);"> нумеруется с 1;</span></li><li><strong style="color: rgb(0, 0, 0);">dev_type</strong><span style="color: rgb(0, 0, 0);"> - это тип устройства, к которому относится пакет;</span></li><li><strong style="color: rgb(0, 0, 0);">cmd</strong><span style="color: rgb(0, 0, 0);"> - это команда протокола;</span></li><li><strong style="color: rgb(0, 0, 0);">cmd_body -</strong><span style="color: rgb(0, 0, 0);"> формат которого зависит от команды протокола. </span></li></ul><p><span style="color: rgb(0, 0, 0);">Тип устройства </span><strong style="color: rgb(0, 0, 0);">dev_type</strong><span style="color: rgb(0, 0, 0);"> и команда </span><strong style="color: rgb(0, 0, 0);">cmd</strong><span style="color: rgb(0, 0, 0);"> в совокупности определяют данные, которые передаются в </span><strong style="color: rgb(0, 0, 0);">cmd_body</strong><span style="color: rgb(0, 0, 0);">, как будет описано далее. Обратите внимание, что dev_type - это тип устройства, к которому относится данная команда. Например, если хаб посылает лампе команду на включение SETSTATUS, то и dev_type у соответствующего пакета должен быть равен 4 (лампа).</span></p><h6>Описание команд протокола (cmd)</h6><ul><li><strong style="color: rgb(0, 0, 0);">0x01 - WHOISHERE</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> отправляется устройством, желающим обнаружить своих соседей в сети. Адрес рассылки dst должен быть широковещательным 0x3FFF. Поле cmd_body описывает характеристики самого устройства в виде структуры:</span></li></ul><pre class="ql-syntax" spellcheck="false">type device struct {
&nbsp; dev_name string
&nbsp; dev_props bytes
};
</pre><p><span style="color: rgb(0, 0, 0);">Содержимое </span><strong style="color: rgb(0, 0, 0);">dev_props</strong><span style="color: rgb(0, 0, 0);"> определяется в зависимости от типа устройства.</span></p><ul><li><strong style="color: rgb(0, 0, 0);">0x02 - IAMHERE</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> отправляется устройством, получившим команду </span><strong style="color: rgb(0, 0, 0);">WHOISHERE,</strong><span style="color: rgb(0, 0, 0);"> и содержит информацию о самом устройстве в поле cmd_body. Команда </span><strong style="color: rgb(0, 0, 0);">IAMHERE</strong><span style="color: rgb(0, 0, 0);"> отправляется строго в ответ на </span><strong style="color: rgb(0, 0, 0);">WHOISHERE</strong><span style="color: rgb(0, 0, 0);">. Команда отправляется на широковещательный адрес.</span></li><li><strong style="color: rgb(0, 0, 0);">0x03 - GETSTATUS</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> отправляется хабом какому-либо устройству для чтения состояния устройства. Если устройство не поддерживает команду GETSTATUS (например, таймер), команда игнорируется. Поле cmd_body должно быть пустым.</span></li><li><strong style="color: rgb(0, 0, 0);">0x04 - STATUS</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> отправляется устройством хабу и как ответ на запросы </span><strong style="color: rgb(0, 0, 0);">GETSTATUS</strong><span style="color: rgb(0, 0, 0);">, </span><strong style="color: rgb(0, 0, 0);">SETSTATUS,</strong><span style="color: rgb(0, 0, 0);"> и самостоятельно при изменении состояния устройства. Например, переключатель (switch) отправляет сообщение </span><strong style="color: rgb(0, 0, 0);">STATUS</strong><span style="color: rgb(0, 0, 0);"> в момент переключения. В этом случае адресом получателя устанавливается устройство, которое последнее отправило данному устройству команду </span><strong style="color: rgb(0, 0, 0);">GETSTATUS</strong><span style="color: rgb(0, 0, 0);">. Если такой команды ещё не поступало, сообщение </span><strong style="color: rgb(0, 0, 0);">STATUS</strong><span style="color: rgb(0, 0, 0);"> не отправляется никому.</span></li><li><strong style="color: rgb(0, 0, 0);">0x05 - SETSTATUS</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> отправляется хабом какому-либо устройству, чтобы устройство изменило свое состояние, например, чтобы включилась лампа. Если устройство не поддерживает изменение состояния (например, таймер), команда игнорируется. dev_type должно устанавливаться в тип устройства, для которого предназначено сообщение.</span></li><li><strong style="color: rgb(0, 0, 0);">0x06 - TICK</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> тик таймера, отправляется таймером. Периодичность отправления не гарантируется, но если на некоторый момент времени запланировано событие, то срабатывание события должно наступать, когда время, передаваемое в сообщении TICK становится больше или равно запланированному. Поле cmd_body содержит следующие данные:</span></li></ul><pre class="ql-syntax" spellcheck="false">type timer_cmd_body struct {
&nbsp; timestamp varuint
};
</pre><p><span style="color: rgb(0, 0, 0);">Поле </span><strong style="color: rgb(0, 0, 0);">timestamp</strong><span style="color: rgb(0, 0, 0);"> содержит текущее время в миллисекундах от 1970-01-01T00:00:00Z (java timestamp). Таким образом точность измерения времени составляет 1 мс, но тики таймера могут отправляться значительно реже, например, раз в 100 мс. Обратите внимание, что таймер показывает модельное время, а не реальное астрономическое время. Работа вашей программы, моделирующей хаб умного дома, должна быть привязана к модельному, а не к астрономическому времени.</span></p><p><span style="color: rgb(0, 0, 0);">Командами </span><strong style="color: rgb(0, 0, 0);">GETSTATUS, STATUS, SETSTATUS</strong><span style="color: rgb(0, 0, 0);"> обмениваются два устройства, одно из которых - ваш хаб. Широковещательные адреса не допускаются.</span></p><p><span style="color: rgb(0, 0, 0);">Устройство должно ответить на широковещательный запрос </span><strong style="color: rgb(0, 0, 0);">WHOISHERE</strong><span style="color: rgb(0, 0, 0);"> не позднее, чем через 300 мс. Устройство должно ответить на запросы </span><strong style="color: rgb(0, 0, 0);">GETSTATUS</strong><span style="color: rgb(0, 0, 0);"> или </span><strong style="color: rgb(0, 0, 0);">SETSTATUS</strong><span style="color: rgb(0, 0, 0);">, адресованные данному устройству, не позднее, чем через 300 мс. Команда </span><strong style="color: rgb(0, 0, 0);">TICK</strong><span style="color: rgb(0, 0, 0);"> не требует ответа.</span></p><h6><span style="color: rgb(0, 0, 0);">Типы устройств</span></h6><ul><li><strong style="color: rgb(0, 0, 0);">0x01 - SmartHub </strong>—<span style="color: rgb(0, 0, 0);"> это устройство, которое моделирует ваша программа, оно единственное устройство этого типа в сети;</span></li><li><strong style="color: rgb(0, 0, 0);">0x02 - EnvSensor</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> датчик характеристик окружающей среды (температура, влажность, освещенность, загрязнение воздуха);</span></li><li><strong style="color: rgb(0, 0, 0);">0x03 - Switch</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> переключатель;</span></li><li><strong style="color: rgb(0, 0, 0);">0x04 - Lamp</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> лампа;</span></li><li><strong style="color: rgb(0, 0, 0);">0x05 - Socket </strong>—<span style="color: rgb(0, 0, 0);"> розетка;</span></li><li><strong style="color: rgb(0, 0, 0);">0x06 - Clock</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> часы, которые широковещательно рассылают сообщения </span><strong style="color: rgb(0, 0, 0);">TICK. </strong><span style="color: rgb(0, 0, 0);">Часы гарантрированно присутствуют в сети и только в одном экземпляре.</span></li></ul><h6><span style="color: rgb(0, 0, 0);">Обработка команд в зависимости от типа устройства</span></h6><ul><li><strong style="color: rgb(0, 0, 0);">SmartHub</strong></li><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">WHOISHERE, IAMHERE </strong>—<span style="color: rgb(0, 0, 0);"> </span><strong style="color: rgb(0, 0, 0);">dev_props</strong><span style="color: rgb(0, 0, 0);"> пуст</span></li><li><strong style="color: rgb(0, 0, 0);">EnvSensor</strong></li><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">WHOISHERE, IAMHERE</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> </span><strong style="color: rgb(0, 0, 0);">dev_props</strong><span style="color: rgb(0, 0, 0);"> имеет следующую структуру:</span></li></ul><pre class="ql-syntax" spellcheck="false">type env_sensor_props struct {
&nbsp; sensors byte
&nbsp; triggers [] struct {
&nbsp; &nbsp; op byte
&nbsp; &nbsp; value varuint
&nbsp; &nbsp; name string
&nbsp; }
};
</pre><ul><li class="ql-indent-1">Поле <strong>sensors</strong> содержит битовую маску поддерживаемых сенсоров, где значения каждого бита обозначают следующее:</li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">0x1</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> имеется датчик температуры (сенсор 0);</span></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">0x2</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> имеется датчик влажности (сенсор 1);</span></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">0x4</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> имеется датчик освещенности (сенсор 2);</span></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">0x8</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> имеется датчик загрязнения воздуха (сенсор 3).</span></li><li class="ql-indent-1"><span style="color: rgb(0, 0, 0);">Поле </span><strong style="color: rgb(0, 0, 0);">triggers</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> массив пороговых значений сенсоров для срабатывания. Здесь операция </span><strong style="color: rgb(0, 0, 0);">op</strong><span style="color: rgb(0, 0, 0);"> имеет следующий формат: </span></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">Бит 0</strong><span style="color: rgb(0, 0, 0);"> (младший) </span>—<span style="color: rgb(0, 0, 0);"> включить или выключить устройство; </span></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">Бит 1</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> сравнивать по условию меньше (0) или больше (1): 0 - триггер срабатывает когда значение сенсора меньше порога, 1 - триггер срабатывает, когда значение сенсора больше порога</span></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">Биты 2-3 </strong>—<span style="color: rgb(0, 0, 0);"> тип сенсора, на который срабатывает триггер (сенсор 0, 1, 2, 3 как описано выше) </span></li><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">Поле value</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> это пороговое значение сенсора; </span></li><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">Поле name</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> имя устройства, которое должно быть включено или выключено.</span></li></ul><p><strong style="color: rgb(0, 0, 0);"><em>Обратите внимание</em></strong><span style="color: rgb(0, 0, 0);">, что </span><strong style="color: rgb(0, 0, 0);">EnvSensor</strong><span style="color: rgb(0, 0, 0);"> не управляет устройствами непосредственно, функция управления переложена на хаб (вашу программу). Когда значение какого-либо сенсора переходит через пороговое, </span><strong style="color: rgb(0, 0, 0);">EnvSensor</strong><span style="color: rgb(0, 0, 0);"> сам отправляет сообщение </span><strong style="color: rgb(0, 0, 0);">STATUS</strong><span style="color: rgb(0, 0, 0);"> по адресу устройства, которое последним запрашивало </span><strong style="color: rgb(0, 0, 0);">GETSTATUS</strong><span style="color: rgb(0, 0, 0);"> у </span><strong style="color: rgb(0, 0, 0);">EnvSensor</strong><span style="color: rgb(0, 0, 0);">. Таким образом нет необходимости в постоянном опросе значений сенсоров со стороны хаба.</span></p><ul><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">STATUS</strong><span style="color: rgb(0, 0, 0);"> </span>—<span style="color: rgb(0, 0, 0);"> поле </span><strong style="color: rgb(0, 0, 0);">cmd_body</strong><span style="color: rgb(0, 0, 0);"> содержит показания всех поддерживаемых устройством сенсоров как массив целых чисел.</span></li></ul><pre class="ql-syntax" spellcheck="false">type env_sensor_status_cmd_body struct {
&nbsp; values []varuint
};
</pre><ul><li class="ql-indent-1"><span style="color: rgb(0, 0, 0);">Показания всегда идут в порядке </span><strong style="color: rgb(0, 0, 0);">температура-влажность-освещенность-загрязнение воздуха</strong><span style="color: rgb(0, 0, 0);">. </span><em style="color: rgb(0, 0, 0);">Например, если сенсор поддерживает датчики температуры и освещенности, то сначала всегда передаётся температура, а затем освещенность.</em><span style="color: rgb(0, 0, 0);"> Физические измерения передаются в следующей форме:</span></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">температура</strong><span style="color: rgb(0, 0, 0);"> </span>измеряется<span style="color: rgb(0, 0, 0);"> в 0.1 Кельвина, то есть температура -273.1 кодируется значением 0, а температура 0 по Цельсию кодируется значением 2731. </span><em style="color: rgb(0, 0, 0);">Примечание: температура в Кельвинах и в Цельсиях связана следующим соотношением:</em><em> <span class="ql-formula" data-value="C = K + 273.1">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo>=</mo><mi>K</mi><mo>+</mo><mn>273.1</mn></mrow><annotation encoding="application/x-tex">C = K + 273.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.07153em;">C</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.07153em;">K</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">7</span><span class="mord">3</span><span class="mord">.</span><span class="mord">1</span></span></span></span></span>﻿</span>, где <span class="ql-formula" data-value="C">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.07153em;">C</span></span></span></span></span>﻿</span> — температура в Цельсиях, а <span class="ql-formula" data-value="K">﻿<span contenteditable="false"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.07153em;">K</span></span></span></span></span>﻿</span> — температура в Кельвинах;</em></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">относительная влажность</strong><span style="color: rgb(0, 0, 0);"> измеряется в промилле, то есть принимает значения от 0 до 1000;</span></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">освещенность измеряется</strong><span style="color: rgb(0, 0, 0);"> в десятых долях люкса;</span></li><li class="ql-indent-2"><strong style="color: rgb(0, 0, 0);">загрязнение воздуха</strong><span style="color: rgb(0, 0, 0);"> измеряется в десятых долях показателя PM2.5.</span></li><li><strong style="color: rgb(0, 0, 0);">Switch</strong></li><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">WHOISHERE, IAMHERE</strong><span style="color: rgb(0, 0, 0);"> </span><em>—</em><span style="color: rgb(0, 0, 0);"> </span><strong style="color: rgb(0, 0, 0);">dev_props</strong><span style="color: rgb(0, 0, 0);"> является массивом строк. Каждая строка </span><em>—</em><span style="color: rgb(0, 0, 0);"> это имя (</span><strong style="color: rgb(0, 0, 0);">dev_name</strong><span style="color: rgb(0, 0, 0);">) устройства, которое подключено к данному выключателю. Включение выключателя должно включать все устройства, а выключение должно выключать. За это отвечает хаб (ваша программа).</span></li><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">STATUS</strong><span style="color: rgb(0, 0, 0);"> </span><em>—</em><span style="color: rgb(0, 0, 0);"> поле </span><strong style="color: rgb(0, 0, 0);">cmd_body</strong><span style="color: rgb(0, 0, 0);"> имеет размер 1 байт и содержит значение 0, если переключатель находится в положении </span><strong style="color: rgb(0, 0, 0);">OFF</strong><span style="color: rgb(0, 0, 0);">, и 1, если переключатель находится в положении </span><strong style="color: rgb(0, 0, 0);">ON.</strong></li><li><strong style="color: rgb(0, 0, 0);">Lamp и Socket</strong></li><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">WHOISHERE, IAMHERE</strong><span style="color: rgb(0, 0, 0);"> </span><em>—</em><span style="color: rgb(0, 0, 0);"> поле </span><strong style="color: rgb(0, 0, 0);">dev_props</strong><span style="color: rgb(0, 0, 0);"> пусто;</span></li><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">STATUS</strong><span style="color: rgb(0, 0, 0);"> </span><em>—</em><span style="color: rgb(0, 0, 0);"> поле </span><strong style="color: rgb(0, 0, 0);">cmd_body</strong><span style="color: rgb(0, 0, 0);"> имеет размер 1 байт и содержит значение 0, если переключатель находится в положении </span><strong style="color: rgb(0, 0, 0);">OFF</strong><span style="color: rgb(0, 0, 0);">, и 1, если переключатель находится в положении </span><strong style="color: rgb(0, 0, 0);">ON;</strong></li><li class="ql-indent-1"><strong style="color: rgb(0, 0, 0);">SETSTATUS</strong><span style="color: rgb(0, 0, 0);"> </span><em>—</em><span style="color: rgb(0, 0, 0);"> поле </span><strong style="color: rgb(0, 0, 0);">cmd_body</strong><span style="color: rgb(0, 0, 0);"> должно иметь размер 1 байт и содержать 0 для выключения устройства и 1 для включения устройства.</span></li></ul><h6><span style="color: rgb(0, 0, 0);">Работа вашей программы</span></h6><p><span style="color: rgb(0, 0, 0);">Вашей программе в аргументе командной строки передается </span><strong style="color: rgb(0, 0, 0);">URL</strong><span style="color: rgb(0, 0, 0);">, который нужно использовать для обмена данными с сетью, и 14-битный адрес вашего устройства-хаба в сети в шестнадцатеричном виде. Для отправки данных в сеть необходимо выполнить </span><strong style="color: rgb(0, 0, 0);">POST</strong><span style="color: rgb(0, 0, 0);">-запрос передав в теле запроса выдаваемые в сеть пакеты данных в виде </span><strong style="color: rgb(0, 0, 0);">URL-encoded Base64</strong><span style="color: rgb(0, 0, 0);"> строки. В ответ </span><strong style="color: rgb(0, 0, 0);">POST</strong><span style="color: rgb(0, 0, 0);">-запрос вернет пакеты данных, принятые из сети. Каждую порцию данных таким образом можно прочитать только один раз. В случае успешного чтения очередной порции данных сервер вернет код ответа </span><strong style="color: rgb(0, 0, 0);">HTTP</strong><span style="color: rgb(0, 0, 0);"> </span><strong style="color: rgb(0, 0, 0);">200</strong><span style="color: rgb(0, 0, 0);">. В случае, когда данных больше нет, сервер вернет код ответа </span><strong style="color: rgb(0, 0, 0);">HTTP</strong><span style="color: rgb(0, 0, 0);"> </span><strong style="color: rgb(0, 0, 0);">204</strong><span style="color: rgb(0, 0, 0);">. При получении кода 204 ваша программа должна завершить свою работу с кодом завершения 0.</span></p><p><span style="color: rgb(0, 0, 0);">Пример запуска вашей программы:</span></p><pre class="ql-syntax" spellcheck="false">solution http://localhost:12183 ef0
</pre><p><br></p><p><span style="color: rgb(0, 0, 0);">Если при взаимодействии с сервером возникла какая-либо ошибка на уровне сети или протокола </span><strong style="color: rgb(0, 0, 0);">HTTP</strong><span style="color: rgb(0, 0, 0);">, или сервер вернул код ответа, отличный от 200 или 204, ваша программа должна завершить выполнение с кодом завершения 99.</span></p><p><span style="color: rgb(0, 0, 0);">Каждая порция входных данных закодирована с помощью </span><strong style="color: rgb(0, 0, 0);">URL-encoded unpadded Base64</strong><span style="color: rgb(0, 0, 0);">, причем все пробельные символы (пробелы, табуляции, переводы строк) являются незначимыми и должны быть проигнорированы. Если порция данных закодирована в base64 некорректно, она должна быть пропущена, и ваша программа должна перейти к обработке следующей порции данных, то есть снова выполнить POST-запрос. Если при декодировании пакета возникла ошибка контрольной суммы, пакет игнорируется.</span></p><p><span style="color: rgb(0, 0, 0);">Ваша программа должна моделировать работу хаба по следующему алгоритму:</span></p><ul><li><span style="color: rgb(0, 0, 0);">В начале работы хаб собирает информацию о сети с помощью запроса </span><strong style="color: rgb(0, 0, 0);">WHOISHERE</strong><span style="color: rgb(0, 0, 0);"> и запрашивает начальное состояние всех устройств. Обратите внимание, что устройства могут задержаться с ответом на запрос, задержки вплоть до 300мс допустимы.</span></li><li><span style="color: rgb(0, 0, 0);">Далее хаб ожидает сообщений от сенсоров, и для каждого сообщения от сенсора выполняются действия, прописанные в </span><strong style="color: rgb(0, 0, 0);">dev_props</strong><span style="color: rgb(0, 0, 0);"> сенсора</span></li></ul><p><span style="color: rgb(0, 0, 0);">Все подключенные устройства кроме хаба и таймера в процессе работы могут быть отключены. Отключенное устройство перестает отвечать на сообщения, адресованные этому устройству. Устройства могут быть включены в процессе работы, и могут появиться новые устройства. Повторно или вновь включенное устройство посылает в сеть запрос </span><strong style="color: rgb(0, 0, 0);">WHOISHERE</strong><span style="color: rgb(0, 0, 0);">, на который хаб должен ответить. Конфигурация устройства (</span><strong style="color: rgb(0, 0, 0);">dev_props</strong><span style="color: rgb(0, 0, 0);">) может отличаться от конфигурации, которая была в прошлый раз, в этом случае хаб должен начать работать с новой конфигурацией.</span></p><p>Здесь под отключением понимается то, что по какой-то причине перестал работать контроллер соответствующего устройства, и поэтому устройство перестало принимать команды и реагировать на них. Но обычно у устройств типа LAMP или SWITCH или SOCKET контроллер устройства принимает команды и реагирует на них, даже если сама по себе лампа не горит.</p><p><span style="color: rgb(0, 0, 0);">Если хаб отправил команду какому-то конкретному устройству и не получил от него ответа в течение 300мс, это устройство считается выключенным и на него больше не отправляется команд, а сообщения от него игнорируются, пока это устройство само не объявит о своем включении с помощью запроса </span><strong style="color: rgb(0, 0, 0);">WHOISHERE</strong><span style="color: rgb(0, 0, 0);">.</span></p><h6><span style="color: rgb(0, 0, 0);">Замечание</span></h6><p><span style="color: rgb(0, 0, 0);">Ваша программа должна полностью размещаться в одном файле исходного кода. Ваша программа </span><strong style="color: rgb(0, 0, 0);">не должна</strong><span style="color: rgb(0, 0, 0);"> ничего считывать со стандартного потока ввода или выводить на стандартный поток вывода, кроме того закрывать эти потоки нельзя. Весь обмен данными ведется с помощью </span><strong style="color: rgb(0, 0, 0);">HTTP POST </strong><span style="color: rgb(0, 0, 0);">запросов.</span></p><h5>Ответы на часто задаваемые вопросы</h5><ul><li>python requests использовать можно</li><li>при отправке команды на лампу или розетку, dev_type нужно проставлять для лампы или розетки соответственно</li><li>даже в выключенном состоянии лампа, розетка и выключатель принимают команды умного дома и реагируют на них</li><li>у команды GETSTATUS поле cmd_body пусто</li><li>единственный способ взаимодействия вашей программы, моделирующей хаб умного дома, и остальных устройств - посылка HTTP POST запроса на сервер, URL которого передается в командной строке при запуске программы</li><li>у хаба поле dev_name может быть любым допустимым</li><li>dev_name и address можно считать уникальными для устройств сети</li><li>в вашей программе вы должны самостоятельно реализовать кодирование и декодирование пакетов, использовать для этой цели демо-сервер нельзя</li><li>программный код для вычисления CRC8 находится по ссылке <a href="http://www.sunshine2k.de/articles/coding/crc/understanding_crc.html" rel="noopener noreferrer" target="_blank" style="color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);">http://www.sunshine2k.de/articles/coding/crc/understanding_crc.html</a></li><li>команда WHOISHERE отправляется устройством только один раз при подключении устройства к сети. В дальнейшем используются только GETSTATUS, SETSTATUS.</li><li>адреса src и dst кодируются в ULEB128 и могут занимать в пакете 1 или 2 байта</li><li>сообщения в формате JSON, приведенные на странице https://github.com/blackav/smart-home-binary, даны для лучшего понимания структуры пакетов и пересылаемых данных. в протоколе взаимодействия устройств в умном доме протокол JSON не используется</li><li>про URL-encoded unpadded base64 можно прочитать в Википедии (https://en.wikipedia.org/wiki/Base64) в разделе "Variants summary table" в строке base64url</li><li>в одном POST-запросе может быть передано ноль или несколько пакетов, ответ на POST-запрос также может содержать ноль или несколько пакетов</li><li>SWITCH - это механический выключатель, аналогичный выключателю света на стене комнаты. Его состояние изменяется извне, и его нельзя изменить программно, поэтому команда SETSTATUS не поддерживается</li><li>SWITCH не управляет устройствами, подключенными к нему, напрямую. Можно считать, что это устройство аналогично кнопке на клавиатуре, которая только посылает сигнал в центральный процессор, а в нашем случае - хаб.</li><li>К EnvSensor и Switch могут программно "подключаться" только устройства Lamp и Socket</li><li>Можно считать, что если в ответе сервера на POST-запрос присутствует TICK, то он будет первым по порядку. В первом ответе сервера на POST-запрос TICK обязательно присутствует и задает начальное модельное время</li><li>В программах на Java если исходный файл состоит из нескольких классов, то функция main должна находиться в первом по порядку классе в файле</li></ul></div><div class="ql-clipboard" contenteditable="true" tabindex="-1"></div></div></app-quill-content-display></div><!----><!----><!----><!----></div><!----></app-programming-task><!----><!----><!----></app-task><!----></div>
